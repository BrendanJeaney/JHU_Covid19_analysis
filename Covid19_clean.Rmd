---
title: "JHU Covid-19 Project"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(tidyverse)
```


```{r, message=FALSE}
  
  knitr::opts_chunk$set(tidy = TRUE)
  
  url_in <- "https://raw.githubusercontent.com/CSSEGISandData/COVID-19/master/csse_covid_19_data/csse_covid_19_time_series/"
  
  file_names <- c("time_series_covid19_confirmed_global.csv", "time_series_covid19_confirmed_US.csv", "time_series_covid19_deaths_US.csv", "time_series_covid19_deaths_global.csv")
  
  urls <- str_c(url_in,file_names)
  
  global_cases = read_csv(urls[1])
  us_cases = read_csv(urls[2])
  us_deaths = read_csv(urls[3])
  global_deaths = read_csv(urls[4])
  
  global_cases <- global_cases %>% pivot_longer(cols=-c(`Province/State`, `Country/Region`,Lat,Long), names_to="date", values_to="cases") %>% select(-c(Lat,Long)) 
  
  global_deaths <- global_deaths %>% pivot_longer(cols=-c(`Province/State`, `Country/Region`,Lat,Long), names_to="date", values_to="deaths") %>% select(-c(Lat,Long))
  
  global <- global_cases %>% full_join(global_deaths) %>% rename(Country_Region = `Country/Region`, Province_State = `Province/State`) %>% mutate(date = mdy(date))
  
  global <- global %>% filter(cases > 0)
  
  us_cases <- us_cases %>% pivot_longer(cols = -(UID:Combined_Key), names_to="date", values_to="cases") %>% select(Admin2:cases) %>% mutate(date = mdy(date)) %>% select(-c(Lat, Long_))
  
  us_deaths <- us_deaths %>% pivot_longer(cols = -(UID:Population), names_to="date", values_to="deaths") %>% select(Admin2:deaths) %>% mutate(date = mdy(date)) %>% select(-c(Lat, Long_))
  
  US <- us_cases %>% full_join(us_deaths)
  
  global <- global %>% unite("Combined_Key", c(Province_State, Country_Region), sep=", ", na.rm = TRUE, remove = FALSE)
  
  uid_lookup_url <- "https://raw.githubusercontent.com/CSSEGISandData/COVID-19/master/csse_covid_19_data/UID_ISO_FIPS_LookUp_Table.csv"
  
  uid <- read_csv(uid_lookup_url) %>% select(-c(Lat, Long_, Combined_Key, code3, iso2, iso3, Admin2))
  
  global <- global %>% left_join(uid, by = c("Province_State", "Country_Region")) %>% select(-c(UID, FIPS)) %>% select(Province_State, Country_Region, date, cases, deaths, Population, Combined_Key) 
  
  
  US_by_state <- US %>% 
                group_by(Province_State, Country_Region, date) %>%
                summarize(cases = sum(cases), deaths = sum(deaths), Population = sum(Population)) %>%
                mutate(deaths_per_mill = deaths * 1000000 / Population) %>% 
                select(Province_State, Country_Region, date, cases, deaths, deaths_per_mill, Population) %>%
                ungroup()
                
  
  US_totals <- US_by_state %>%
              group_by(Country_Region, date) %>%
              summarize(cases = sum(cases), deaths = sum(deaths), Population = sum(Population)) %>%
                mutate(deaths_per_mill = deaths * 1000000 / Population) %>% 
                select(Country_Region, date, cases, deaths, deaths_per_mill, Population) %>%
                ungroup()
                
                
  US_by_state <- US_by_state %>% 
    mutate(new_cases = cases - lag(cases),new_deaths = deaths - lag(deaths))
                        
  US_totals <- US_totals %>% 
    mutate(new_cases = cases - lag(cases),new_deaths = deaths - lag(deaths))
  
   
  US_state_totals <- US_by_state %>%
      group_by(Province_State) %>%
      summarize(deaths = max(deaths), cases = max(cases), population = max(Population), cases_per_thou = 1000 * cases / population, deaths_per_thou = 1000 * deaths / population) %>%
      filter(cases > 0, population > 0)
      
  
  mod <- lm(deaths_per_thou ~ cases_per_thou, data = US_state_totals)
  
  
  pop_mod_deaths <- lm(deaths ~ population, data = US_state_totals)
  pop_mod_cases <- lm(cases ~ population, data = US_state_totals)
  
  US_tot_w_preds_pop <- US_state_totals %>% mutate(pred = predict(pop_mod_deaths))
  US_tot_w_preds_cases <- US_state_totals %>% mutate(pred = predict(pop_mod_cases))
  
  US_tot_w_preds_pop %>% ggplot() + 
      geom_point(aes(x = population, y = deaths), color="blue") + 
      geom_point(aes(x = population, y = pred), color="black")
  
  US_tot_w_preds_cases %>% ggplot() + 
      geom_point(aes(x = population, y = cases), color="blue") + 
      geom_point(aes(x = population, y = pred), color="black")
  
  summary(pop_mod_deaths)$r.squared
  summary(pop_mod_cases)$r.squared
  
  
  US_tot_w_preds_cases_above <- US_tot_w_preds_cases %>% filter(cases>pred)
  US_tot_w_preds_cases_below <- US_tot_w_preds_cases %>% filter(cases<pred)
  
  
  US_tot_w_preds_pop <- US_tot_w_preds_pop %>% mutate(over_pred = deaths > pred)
  
  over_preds_top11 = US_tot_w_preds_pop %>% slice_max(population, n = 11) %>% select(Province_State, deaths, over_pred, everything()) %>% summarise(over_preds = sum(over_pred))
  
  over_preds_top11
  
  over_preds_top25 = US_tot_w_preds_pop %>% slice_max(population, n = 25) %>% select(Province_State, deaths, over_pred, everything()) %>% summarise(over_preds = sum(over_pred)) / 25
  
  over_preds_top25
  
  over_preds_bot25 = US_tot_w_preds_pop %>% slice_min(population, n = 25) %>% select(Province_State, deaths, over_pred, everything()) %>% summarise(over_preds = sum(over_pred)) / 25
  
  over_preds_bot25
  
  over_preds_bot17 = US_tot_w_preds_pop %>% slice_min(population, n = 17) %>% select(Province_State, deaths, over_pred, everything()) %>% summarise(over_preds = sum(over_pred))
  
  over_preds_bot17
  
  
```


## US State Analysis
Population is very strongly correlated with the number of cases and deaths in US when separated into states. Cases are slightly more correlated with population than deaths. It is also worth noting that of the top 11 most populated states, only 2 fell below the linear regression line. On the flip side, The 17 least populated states/provinces all fell below their predicted number of cases generated by the linear model.

<br/><br/><br/>

  
``` {r, message=FALSE}  
  
  
  
  global_by_country <- global %>% 
                group_by(Country_Region, date) %>%
                summarize(cases = sum(cases), deaths = sum(deaths), Population = sum(Population)) %>%
                mutate(deaths_per_thou = deaths * 1000 / Population, cases_per_thou = cases * 1000 / Population) %>% 
                select(Country_Region, date, cases, deaths, deaths_per_thou, cases_per_thou, Population) %>%
                ungroup()
                
  
  global_totals <- global_by_country %>%
              group_by(Country_Region, date) %>%
              summarize(cases = sum(cases), deaths = sum(deaths), Population = sum(Population)) %>%
                mutate(deaths_per_thou = deaths * 1000 / Population, cases_per_thou = cases * 1000 / Population) %>% 
                select(Country_Region, date, cases, deaths, deaths_per_thou, cases_per_thou, Population) %>%
                ungroup()
  
  
  global_by_country <- global_by_country %>% 
    mutate(new_cases = cases - lag(cases),new_deaths = deaths - lag(deaths))
  #                       
  global_totals <- global_totals %>% 
    mutate(new_cases = cases - lag(cases),new_deaths = deaths - lag(deaths))
  
  global_country_totals <- global_by_country %>%
      group_by(Country_Region) %>%
      summarize(deaths = max(deaths), cases = max(cases), population = max(Population), cases_per_thou = 1000 * cases / population, deaths_per_thou = 1000 * deaths / population) %>%
      filter(cases > 0, population > 0)
  

  pop_mod_deaths_global <- lm(deaths ~ population, data = global_country_totals)
  pop_mod_cases_global <- lm(cases ~ population, data = global_country_totals)
  
  global_tot_w_preds_pop <- global_country_totals %>% mutate(pred = predict(pop_mod_deaths_global))
  global_tot_w_preds_cases <- global_country_totals %>% mutate(pred = predict(pop_mod_cases_global))
  
  global_tot_w_preds_pop %>% ggplot() + 
      geom_point(aes(x = population, y = deaths), color="blue") + 
      geom_point(aes(x = population, y = pred), color="black")
  
  global_tot_w_preds_cases %>% ggplot() + 
      geom_point(aes(x = population, y = cases), color="blue") + 
      geom_point(aes(x = population, y = pred), color="black")  
  
  summary(pop_mod_deaths_global)$r.squared
  summary(pop_mod_cases_global)$r.squared

```

## Country based Analysis
Despite Population being a very strong indicator of case and death totals for states in the United States, they are not highly correlated on a global scale. It was likely so highly correlated inside of the US due to federal policy being consistent across states. Different countries took different approaches to handling covid and that leads to a lower correlation. Also things such as what is reported as a covid death and the number of tests that were done lead to a higher correlation. 

<br/><br/><br/>


## Bias
 * The data is self reported data by each country/region, therefore there is bound to be inaccuracies and inconsistencies

<br/><br/>